{"version":3,"file":"react-map-gl-cluster.cjs.js","sources":["../src/utils/point.js","../src/utils/shallowCompareChildren.js","../src/components/Cluster/index.js"],"sourcesContent":["// @flow\n\nconst point = (\n  coordinates: [number, number],\n  properties: { [string]: any } = {}\n) => ({\n  type: 'Feature',\n  properties,\n  geometry: {\n    type: 'Point',\n    coordinates\n  }\n});\n\nexport default point;\n","// @flow\n\nimport { Children } from 'react';\nimport type { Node } from 'react';\n\nconst childrenKeys = (children: Node): string[] =>\n  Children.toArray(children).map(child => child.key);\n\nconst shallowCompareChildren = (\n  prevChildren: Node,\n  newChildren: Node\n): boolean => {\n  if (Children.count(prevChildren) !== Children.count(newChildren)) {\n    return false;\n  }\n\n  const prevKeys = childrenKeys(prevChildren);\n  const newKeys = new Set(childrenKeys(newChildren));\n  return prevKeys.every(key => newKeys.has(key));\n};\n\nexport default shallowCompareChildren;\n","// @flow\n\nimport Supercluster from 'supercluster';\nimport { Children, PureComponent, createElement } from 'react';\nimport { MapContext } from '@urbica/react-map-gl';\nimport type MapboxMap from 'mapbox-gl/src/ui/map';\n\nimport point from '../../utils/point';\nimport shallowCompareChildren from '../../utils/shallowCompareChildren';\n\nexport type SuperclusterFeature = {\n  type: 'Feature',\n  id: number,\n  properties: {\n    cluster: true,\n    cluster_id: number,\n    point_count: number,\n    point_count_abbreviated: string | number\n  },\n  geometry: {\n    type: 'Point',\n    coordinates: [number, number]\n  }\n};\n\nexport type ClusterComponentProps = {\n  longitude: number,\n  latitude: number,\n  clusterId: number,\n  pointCount: number,\n  pointCountAbbreviated: string | number\n};\n\nexport type ClusterMapFunction = (props: {}) => any;\n\nexport type ClusterReduceFunction = (accumulated: {}, props: {}) => void;\n\nexport type ClusterComponent = React$Component<ClusterComponentProps, any>;\n\ntype Props = {\n  /** Minimum zoom level at which clusters are generated */\n  minZoom?: number,\n\n  /** Maximum zoom level at which clusters are generated */\n  maxZoom?: number,\n\n  /** Cluster radius, in pixels */\n  radius?: number,\n\n  /** (Tiles) Tile extent. Radius is calculated relative to this value */\n  extent?: number,\n\n  /** Size of the KD-tree leaf node. Affects performance */\n  nodeSize?: number,\n\n  /**\n   * A function that returns cluster properties\n   * corresponding to a single point.\n   *  */\n  // eslint-disable-next-line react/no-unused-prop-types\n  map?: ClusterMapFunction,\n\n  /** A reduce function that merges properties of two clusters into one. */\n  // eslint-disable-next-line react/no-unused-prop-types\n  reduce?: ClusterReduceFunction,\n\n  /** React Component for rendering Cluster */\n  component: Class<ClusterComponent>,\n\n  /** List of Markers */\n  children: React$Node\n};\n\ntype State = {\n  clusters: Array<Object>\n};\n\nclass Cluster extends PureComponent<Props, State> {\n  _map: MapboxMap;\n\n  _cluster: Object;\n\n  static displayName = 'Cluster';\n\n  static defaultProps = {\n    minZoom: 0,\n    maxZoom: 16,\n    radius: 40,\n    extent: 512,\n    nodeSize: 64\n  };\n\n  constructor(props: Props) {\n    super(props);\n\n    this.state = {\n      clusters: []\n    };\n  }\n\n  componentDidMount() {\n    this._createCluster(this.props);\n    this._recalculate();\n\n    this._map.on('moveend', this._recalculate);\n  }\n\n  componentDidUpdate(prevProps: Props) {\n    const shouldUpdate =\n      prevProps.minZoom !== this.props.minZoom ||\n      prevProps.maxZoom !== this.props.maxZoom ||\n      prevProps.radius !== this.props.radius ||\n      prevProps.extent !== this.props.extent ||\n      prevProps.nodeSize !== this.props.nodeSize ||\n      !shallowCompareChildren(prevProps.children, this.props.children);\n\n    if (shouldUpdate) {\n      this._createCluster(this.props);\n      this._recalculate();\n    }\n  }\n\n  componentWillUnmount() {\n    if (!this._map || !this._map.getStyle()) {\n      return;\n    }\n\n    this._map.off('moveend', this._recalculate);\n  }\n\n  getCluster() {\n    return this._cluster;\n  }\n\n  _createCluster = (props: Props) => {\n    const {\n      minZoom,\n      maxZoom,\n      radius,\n      extent,\n      nodeSize,\n      children,\n      reduce,\n      map\n    } = props;\n\n    const cluster = new Supercluster({\n      minZoom,\n      maxZoom,\n      radius,\n      extent,\n      nodeSize,\n      reduce,\n      map\n    });\n\n    const points = Children.map(children, child =>\n      point([child.props.longitude, child.props.latitude], child)\n    );\n\n    cluster.load(points);\n    this._cluster = cluster;\n  };\n\n  _recalculate = () => {\n    const zoom = this._map.getZoom();\n    const bounds = this._map.getBounds().toArray();\n    const bbox = bounds[0].concat(bounds[1]);\n\n    const clusters = this._cluster.getClusters(bbox, Math.round(zoom));\n    this.setState(() => ({ clusters }));\n  };\n\n  _renderCluster = (cluster: SuperclusterFeature) => {\n    const [longitude, latitude] = cluster.geometry.coordinates;\n    const {\n      cluster_id: clusterId,\n      point_count: pointCount,\n      point_count_abbreviated: pointCountAbbreviated\n    } = cluster.properties;\n\n    return createElement(this.props.component, {\n      longitude,\n      latitude,\n      clusterId,\n      pointCount,\n      pointCountAbbreviated,\n      key: `cluster-${cluster.properties.cluster_id}`\n    });\n  };\n\n  render() {\n    return createElement(MapContext.Consumer, {}, (map) => {\n      if (map) {\n        this._map = map;\n      }\n\n      if (this.state.clusters.length === 0) {\n        return null;\n      }\n\n      const clusters = this.state.clusters.map((cluster) => {\n        if (cluster.properties.cluster) {\n          return this._renderCluster(cluster);\n        }\n        const { type, key, props } = cluster.properties;\n        return createElement(type, { key, ...props });\n      });\n\n      return clusters;\n    });\n  }\n}\n\nexport default Cluster;\n"],"names":["point","coordinates","properties","type","geometry","childrenKeys","children","Children","toArray","map","child","key","shallowCompareChildren","prevChildren","newChildren","count","prevKeys","newKeys","Set","every","has","Cluster","props","minZoom","maxZoom","radius","extent","nodeSize","reduce","cluster","Supercluster","points","longitude","latitude","load","_cluster","zoom","_this","_map","getZoom","bounds","getBounds","bbox","concat","clusters","getClusters","Math","round","setState","clusterId","cluster_id","pointCount","point_count","pointCountAbbreviated","point_count_abbreviated","createElement","component","state","componentDidMount","_createCluster","this","_recalculate","on","componentDidUpdate","prevProps","componentWillUnmount","getStyle","off","getCluster","render","MapContext","Consumer","_this2","length","_renderCluster","PureComponent"],"mappings":"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"}